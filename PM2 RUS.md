# Руководство по PM2 для Node.js проектов

PM2 — это популярный менеджер процессов для приложений Node.js, который помогает запускать, мониторить и автоматически перезапускать ваши приложения в производственной среде. Он обеспечивает автоматический рестарт при сбоях, возможность кластерного запуска для распределения нагрузки по всем ядрам процессора и удобное управление логами. Это руководство объясняет, как установить PM2, запустить и управлять вашим приложением, а также предоставляет основные команды с примерами.

---

## Оглавление

- [1. Установка PM2](#1-установка-pm2)
  - [1.1. Предварительные условия](#11-предварительные-условия)
  - [1.2. Глобальная установка PM2](#12-глобальная-установка-pm2)
- [2. Запуск приложения с PM2](#2-запуск-приложения-с-pm2)
  - [2.1. Запуск приложения](#21-запуск-приложения)
  - [2.2. Режим слежения (watch mode)](#22-режим-слежения-watch-mode)
- [3. Основные команды PM2](#3-основные-команды-pm2)
  - [3.1. Просмотр списка процессов](#31-просмотр-списка-процессов)
  - [3.2. Остановка приложения](#32-остановка-приложения)
  - [3.3. Перезапуск приложения](#33-перезапуск-приложения)
  - [3.4. Удаление приложения](#34-удаление-приложения)
  - [3.5. Просмотр логов](#35-просмотр-логов)
  - [3.6. Очистка логов](#36-очистка-логов)
- [4. Автоматизация управления процессами](#4-автоматизация-управления-процессами)
  - [4.1. Сохранение текущего состояния процессов](#41-сохранение-текущего-состояния-процессов)
  - [4.2. Настройка автозапуска на сервере](#42-настройка-автозапуска-на-сервере)
- [5. Экспорт и импорт процессов](#5-экспорт-и-импорт-процессов)
- [6. Использование конфигурационного файла (ecosystem.config.js)](#6-использование-конфигурационного-файла-ecosystemconfigjs)
- [7. PM2 Deploy (автоматический деплой)](#7-pm2-deploy-автоматический-деплой)
- [Заключение](#заключение)

---

## 1. Установка PM2

### 1.1. Предварительные условия

Перед установкой PM2 убедитесь, что на вашем сервере установлены Node.js и npm. Проверьте их версии:

```bash
node -v
npm -v
```


### 1.2. Глобальная установка PM2

Установите PM2 глобально с помощью npm:

```bash
npm install -g pm2
```

Проверьте, что установка прошла успешно:

```bash
pm2 -v
```

---

## 2. Запуск приложения с PM2

### 2.1. Запуск приложения

Перейдите в директорию вашего проекта:

```bash
cd /path/to/your/project
```

Запустите ваше Node.js приложение через PM2, задав ему понятное имя:

```bash
pm2 start app.js --name my-app
```

_Примечание:_ Замените `app.js` на файл с точкой входа вашего приложения, а `my-app` — на нужное вам имя.

### 2.2. Режим слежения (watch mode)

Для разработки можно включить режим слежения, чтобы PM2 автоматически перезапускал приложение при изменении файлов:

```bash
pm2 start app.js --name my-app --watch
```

---

## 3. Основные команды PM2

### 3.1. Просмотр списка процессов

Чтобы увидеть все запущенные процессы, выполните:

```bash
pm2 list
```

Эта команда выводит таблицу с информацией о каждом процессе (ID, имя, статус, использование CPU и памяти, рабочая директория).

### 3.2. Остановка приложения

Остановить приложение можно по его имени или ID:

```bash
pm2 stop my-app
```

или

```bash
pm2 stop 0
```

### 3.3. Перезапуск приложения

Для перезапуска приложения (например, после обновления кода) используйте:

```bash
pm2 restart my-app
```

или

```bash
pm2 restart 0
```

### 3.4. Удаление приложения

Чтобы удалить приложение из PM2, выполните:

```bash
pm2 delete my-app
```

или

```bash
pm2 delete 0
```

### 3.5. Просмотр логов

Для просмотра логов конкретного приложения:

```bash
pm2 logs my-app
```

Для просмотра логов всех процессов:

```bash
pm2 logs
```

### 3.6. Очистка логов

Чтобы очистить все лог-файлы PM2, используйте:

```bash
pm2 flush
```

---

## 4. Автоматизация управления процессами

### 4.1. Сохранение текущего состояния процессов

После того как вы запустили приложение через PM2, сохраните его состояние, чтобы оно могло быть автоматически восстановлено после перезагрузки сервера:

```bash
pm2 save
```

### 4.2. Настройка автозапуска на сервере

Чтобы PM2 и все запущенные процессы автоматически запускались при перезагрузке сервера, выполните:

```bash
pm2 startup
```

Эта команда выведет инструкцию с командой, которую необходимо выполнить с правами суперпользователя (например, через `sudo`). После выполнения этой команды сохраните состояние процессов снова:

```bash
pm2 save
```

---

## 5. Экспорт и импорт процессов

### 5.1. Экспорт списка процессов

Чтобы сохранить текущий список процессов в файл (dump), выполните:

```bash
pm2 dump
```

### 5.2. Восстановление процессов

Если сервер перезагрузился или вам нужно восстановить процессы из сохранённого состояния, выполните:

```bash
pm2 resurrect
```

---

## 6. Использование конфигурационного файла (ecosystem.config.js)

PM2 позволяет управлять приложениями через конфигурационный файл, что упрощает настройку переменных окружения, кластерного режима и деплоя нескольких приложений.

### 6.1. Пример файла ecosystem.config.js

```js
module.exports = {
  apps: [
    {
      name: "my-app",
      script: "app.js",
      exec_mode: "cluster", // Режим кластера для использования всех ядер процессора
      instances: "max", // Запуск максимального количества инстансов
      watch: false, // Отключить слежение за изменениями (подходит для production)
      env: {
        NODE_ENV: "production",
        PORT: 3000,
      },
    },
  ],
  deploy: {
    production: {
      user: "your_server_user",
      host: "your_server_ip",
      ref: "origin/main",
      repo: "git@github.com:yourusername/yourrepo.git",
      path: "/path/to/your/project",
      "post-deploy":
        "npm install && pm2 reload ecosystem.config.js --env production",
    },
  },
};
```

### 6.2. Запуск приложения через конфигурационный файл

Чтобы запустить приложение с использованием конфигурационного файла, выполните:

```bash
pm2 start ecosystem.config.js
```

---

## 7. PM2 Deploy (автоматический деплой)

PM2 имеет встроенную систему деплоя, которая позволяет автоматически обновлять приложение на удалённом сервере при пуше новых изменений в репозиторий.

### 7.1. Настройка деплоя в ecosystem.config.js

В разделе `deploy` конфигурационного файла укажите:

- **user** – SSH-пользователь на сервере.
- **host** – IP-адрес сервера.
- **repo** – SSH URL репозитория.
- **path** – Путь на сервере, куда будет клонироваться проект.
- **post-deploy** – Команды, которые необходимо выполнить после деплоя (например, установка зависимостей и перезапуск приложения).

### 7.2. Запуск деплоя

1. Настройте деплой:
   ```bash
   pm2 deploy ecosystem.config.js production setup
   ```
2. Выполните деплой:
   ```bash
   pm2 deploy ecosystem.config.js production
   ```

God Save The JS!
