````markdown
# Руководство по PM2 для Node.js проектов

PM2 – это популярный менеджер процессов для Node.js, который позволяет запускать, мониторить и перезапускать приложения в производственной среде. Он обеспечивает автоматический рестарт при сбоях, распределение нагрузки в кластерном режиме и удобное управление логами. Этот гайд описывает, как установить PM2, запустить и управлять приложением, а также основные команды для его использования.

---

## 1. Установка PM2

### 1.1. Предварительные условия

Убедитесь, что у вас установлены Node.js и npm. Проверьте версии:

```bash
node -v
npm -v
```
````

### 1.2. Установка PM2

Для установки PM2 глобально выполните:

```bash
npm install -g pm2
```

Проверьте, что установка прошла успешно:

```bash
pm2 -v
```

---

## 2. Запуск приложения с PM2

### 2.1. Запуск приложения

Перейдите в директорию вашего проекта:

```bash
cd /path/to/your/project
```

Запустите ваше Node.js приложение через PM2, задав ему имя:

```bash
pm2 start app.js --name my-app
```

_Примечание:_ Замените `app.js` на основной файл вашего приложения, а `my-app` — на желаемое имя.

### 2.2. Запуск с опцией слежения

Чтобы PM2 автоматически перезапускал приложение при изменении файлов (для разработки), используйте:

```bash
pm2 start app.js --name my-app --watch
```

---

## 3. Основные команды PM2

### 3.1. Просмотр списка процессов

Чтобы увидеть все запущенные процессы:

```bash
pm2 list
```

Эта команда выводит таблицу с информацией о каждом процессе, включая ID, имя, статус, использование CPU и памяти.

### 3.2. Остановка приложения

Остановить приложение можно по его имени или ID:

```bash
pm2 stop my-app
```

или

```bash
pm2 stop 0
```

### 3.3. Перезапуск приложения

После обновления кода можно перезапустить приложение:

```bash
pm2 restart my-app
```

или

```bash
pm2 restart 0
```

### 3.4. Удаление приложения из PM2

Чтобы удалить приложение из списка PM2:

```bash
pm2 delete my-app
```

или

```bash
pm2 delete 0
```

### 3.5. Просмотр логов

Для просмотра логов приложения в реальном времени:

```bash
pm2 logs my-app
```

Чтобы увидеть логи всех процессов, выполните:

```bash
pm2 logs
```

### 3.6. Очистка логов

Для очистки всех логов PM2:

```bash
pm2 flush
```

---

## 4. Автоматизация и управление процессами

### 4.1. Сохранение текущего состояния процессов

После настройки и запуска приложений сохраните их состояние, чтобы PM2 мог восстановить их при перезагрузке сервера:

```bash
pm2 save
```

### 4.2. Автоматический запуск PM2 при старте сервера

Чтобы приложения автоматически запускались после перезагрузки сервера, выполните:

```bash
pm2 startup
```

Команда выдаст инструкцию с командой, которую нужно выполнить с правами суперпользователя (например, через `sudo`). После её выполнения снова сохраните состояние:

```bash
pm2 save
```

---

## 5. Экспорт и импорт процессов

### 5.1. Экспорт списка процессов

Чтобы сохранить текущий список процессов в файл:

```bash
pm2 dump
```

### 5.2. Восстановление процессов

После сбоя или на новом сервере восстановите процессы с помощью:

```bash
pm2 resurrect
```

---

## 6. Использование конфигурационного файла (ecosystem.config.js)

PM2 позволяет управлять приложениями через конфигурационный файл, что удобно для управления несколькими приложениями и настройки переменных окружения.

### 6.1. Пример файла ecosystem.config.js

```js
module.exports = {
  apps: [
    {
      name: "my-app",
      script: "app.js",
      exec_mode: "cluster", // Режим кластера для использования всех ядер процессора
      instances: "max", // Запуск максимального количества инстансов
      watch: false, // Включить слежение за изменениями (разработческая опция)
      env: {
        NODE_ENV: "production",
        PORT: 3000,
      },
    },
  ],
  deploy: {
    production: {
      user: "your_server_user",
      host: "your_server_ip",
      ref: "origin/main",
      repo: "git@github.com:yourusername/yourrepo.git",
      path: "/path/to/your/project",
      "post-deploy":
        "npm install && pm2 reload ecosystem.config.js --env production",
    },
  },
};
```

### 6.2. Запуск приложения через ecosystem.config.js

Чтобы запустить приложение, используя конфигурационный файл:

```bash
pm2 start ecosystem.config.js
```

---

## 7. PM2 Deploy (автоматический деплой)

PM2 также поддерживает автоматический деплой, что позволяет обновлять приложение на сервере по пушу в репозиторий.

### 7.1. Настройка деплоя в ecosystem.config.js

В разделе `deploy` задаются параметры:

- `user` – имя пользователя на сервере.
- `host` – IP-адрес сервера.
- `repo` – URL репозитория (используйте SSH-URL).
- `path` – путь на сервере, куда будет клонироваться репозиторий.
- `post-deploy` – команды, выполняемые после деплоя (установка зависимостей, перезапуск приложения).

### 7.2. Настройка и запуск деплоя

1. Настройте деплой:
   ```bash
   pm2 deploy ecosystem.config.js production setup
   ```
2. Выполните деплой:
   ```bash
   pm2 deploy ecosystem.config.js production
   ```

---

## 8. Таблица полезных команд PM2

| Команда                          | Описание                                           |
| -------------------------------- | -------------------------------------------------- |
| `pm2 start app.js --name my-app` | Запуск приложения с заданным именем                |
| `pm2 list`                       | Вывод списка всех запущенных процессов             |
| `pm2 stop my-app`                | Остановка приложения                               |
| `pm2 restart my-app`             | Перезапуск приложения                              |
| `pm2 delete my-app`              | Удаление приложения из PM2                         |
| `pm2 logs my-app`                | Просмотр логов конкретного приложения              |
| `pm2 flush`                      | Очистка всех логов                                 |
| `pm2 save`                       | Сохранение текущего состояния процессов            |
| `pm2 resurrect`                  | Восстановление процессов из сохраненного состояния |
| `pm2 startup`                    | Настройка автозапуска PM2 при загрузке сервера     |

---

## Заключение

PM2 – это мощный инструмент для управления Node.js приложениями в продакшене. Он позволяет:

- **Автоматически перезапускать** приложения при сбоях.
- **Мониторить** процессы и просматривать логи.
- Обеспечивать **автозапуск** при перезагрузке сервера.
- Упрощать процесс деплоя через конфигурационные файлы и встроенные команды.

Использование PM2 значительно повышает надёжность и удобство управления вашими Node.js приложениями. Если вам нужно больше информации, посетите [официальную документацию PM2](https://pm2.keymetrics.io/).

God save JS!

```

```
